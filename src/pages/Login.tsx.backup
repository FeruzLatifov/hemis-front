import { useState, useRef } from 'react'
import { useNavigate } from 'react-router-dom'
import { useTranslation } from 'react-i18next'
import { toast } from 'sonner'
import { useAuthStore } from '../stores/authStore'
import hemisLogo from '../assets/images/hemis-logo-new.png'
import {
  Lock,
  User,
  Eye,
  EyeOff,
  Globe,
  ChevronDown,
} from 'lucide-react'

const LoginClean = () => {
  const { t, i18n } = useTranslation()
  const navigate = useNavigate()
  const { login } = useAuthStore()

  const formRef = useRef<HTMLFormElement>(null)
  const [username, setUsername] = useState('admin')
  const [password, setPassword] = useState('admin123')
  const [showPassword, setShowPassword] = useState(false)
  const [isLoading, setIsLoading] = useState(false)
  const [currentLang, setCurrentLang] = useState<'uz' | 'oz' | 'ru' | 'en'>(
    (i18n.language as 'uz' | 'oz' | 'ru' | 'en') || 'uz'
  )
  const [isLangDropdownOpen, setIsLangDropdownOpen] = useState(false)

  const handleLanguageChange = (lang: 'uz' | 'oz' | 'ru' | 'en') => {
    setCurrentLang(lang)
    i18n.changeLanguage(lang)
    localStorage.setItem('locale', lang)
    setIsLangDropdownOpen(false)
  }

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault()

    // Show native browser validation bubble (e.g., "Заполните это поле.")
    if (formRef.current && !formRef.current.checkValidity()) {
      formRef.current.reportValidity()
      return
    }

    setIsLoading(true)

    try {
      await login({
        username: username.trim(),
        password: password.trim(),
        locale: currentLang,
      })

      toast.success(t('login.success') || 'Tizimga muvaffaqiyatli kirdingiz', {
        duration: 2000,
        position: 'bottom-right',
      })

      setTimeout(() => {
        setIsLoading(false)
        navigate('/dashboard', { replace: true })
      }, 500)

      return
    } catch (err: unknown) {
      const error = err as Error & { code?: string; response?: unknown };
      console.error('[LoginClean] Login error:', error)
      
      // Check if it's a network error (backend not reachable)
      if (error.code === 'ERR_NETWORK' || 
          error.code === 'ERR_CONNECTION_REFUSED' || 
          error.message === 'Network Error' ||
          !error.response) {
        console.log('[LoginClean] Network error detected - Backend server is not running')
        toast.error('❌ Backend server ishlamayapti. Iltimos, serverni ishga tushiring.', {
          duration: 8000,
          position: 'bottom-right',
        })
        setIsLoading(false)
        return
      }

      // Backend responded with an error
      interface ErrorResponse {
        message?: string;
        error?: { message?: string };
        error_description?: string;
      }
      const errorData = error.response as { data?: ErrorResponse } | undefined;
      const errorMessage =
        errorData?.data?.message ||
        errorData?.data?.error?.message ||
        errorData?.data?.error_description ||
        t('login.errors.invalidCredentials')

      console.log('[LoginClean] Backend error:', errorMessage)
      toast.error(errorMessage, {
        duration: 5000,
        position: 'bottom-right',
      })
      setIsLoading(false)
    }
  }

  const languages = [
    { code: 'uz' as const },
    { code: 'oz' as const },
    { code: 'ru' as const },
    { code: 'en' as const },
  ]

  const displayName = (code: 'uz' | 'oz' | 'ru' | 'en') => {
    if (code === 'uz') return "O'zbek"
    if (code === 'oz') return 'Ўзбек'
    if (code === 'ru') return 'Русский'
    return 'English'
  }

  const inputStyle = {
    borderColor: 'var(--border-color-pro)',
    backgroundColor: 'var(--card-bg)',
    color: 'var(--text-primary)',
  }

  return (
    <div className="min-h-screen flex items-center justify-center" style={{ backgroundColor: 'var(--app-bg)' }}>
      {/* Top Right Language Selector */}
      <div className="absolute top-6 right-6 z-20 flex items-center gap-2">
        <div className="relative">
          <button
            type="button"
            onClick={() => setIsLangDropdownOpen(!isLangDropdownOpen)}
            className="flex items-center gap-2 rounded-lg px-3 py-2 transition-all"
            style={{
              backgroundColor: 'var(--card-bg)',
              borderWidth: '1px',
              borderColor: 'var(--border-color-pro)',
              boxShadow: 'var(--shadow-sm)'
            }}
            disabled={isLoading}
          >
            <Globe className="w-4 h-4" style={{ color: 'var(--text-secondary)' }} />
            <span className="text-sm font-medium" style={{ color: 'var(--text-primary)' }}>
              {displayName(currentLang)}
            </span>
            <ChevronDown
              className={`w-4 h-4 transition-transform duration-200 ${isLangDropdownOpen ? 'rotate-180' : ''}`}
              style={{ color: 'var(--text-secondary)' }}
            />
          </button>

          {isLangDropdownOpen && (
            <div
              className="absolute top-full right-0 mt-2 w-48 rounded-lg overflow-hidden"
              style={{
                backgroundColor: 'var(--card-bg)',
                borderWidth: '1px',
                borderColor: 'var(--border-color-pro)',
                boxShadow: '0 4px 6px rgba(15, 23, 42, 0.1)'
              }}
            >
              {languages.map((lang) => (
                <button
                  key={lang.code}
                  type="button"
                  onClick={() => handleLanguageChange(lang.code)}
                  className="w-full flex items-center gap-3 px-4 py-3 transition-colors"
                  style={{
                    backgroundColor: currentLang === lang.code ? 'var(--primary)' : 'var(--card-bg)',
                    color: currentLang === lang.code ? 'white' : 'var(--text-primary)'
                  }}
                  onMouseEnter={(e) => {
                    if (currentLang !== lang.code) {
                      e.currentTarget.style.backgroundColor = 'var(--active-bg)'
                    }
                  }}
                  onMouseLeave={(e) => {
                    if (currentLang !== lang.code) {
                      e.currentTarget.style.backgroundColor = 'var(--card-bg)'
                    }
                  }}
                  disabled={isLoading}
                >
                  <span className="text-sm font-medium">{displayName(lang.code)}</span>
                </button>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* Main Container */}
      <div className="container mx-auto px-4 w-full">
        <div className="max-w-md mx-auto w-full">
          <div className="w-full">
            <div className="card-professional p-8">
              {/* Logo and Title */}
              <div className="text-center mb-6">
                <div className="flex justify-center mb-4">
                  <div
                    className="w-16 h-16 rounded-lg flex items-center justify-center border p-2"
                    style={{
                      borderColor: 'var(--primary)',
                      backgroundColor: 'white'
                    }}
                  >
                    <img src={hemisLogo} alt="HEMIS" className="w-full h-full object-contain" />
                  </div>
                </div>

                <h1 className="heading-page mb-2">HEMIS</h1>
                <p className="text-caption">{t('login.subtitle')}</p>
              </div>

              {/* Demo Info */}
              <div className="mb-4 p-3 rounded-md text-center" style={{ 
                backgroundColor: 'var(--active-bg)',
                borderWidth: '1px',
                borderColor: 'var(--primary)'
              }}>
                <p className="text-xs font-medium" style={{ color: 'var(--primary)' }}>
                  Demo: admin / admin123
                </p>
              </div>

              {/* Login Form */}
              <form ref={formRef} onSubmit={handleLogin} className="space-y-4">
                {/* Username Input */}
                <div>
                  <div className="relative">
                    <input
                      type="text"
                      value={username}
                      onChange={(e) => setUsername(e.target.value)}
                      placeholder={t('login.usernamePlaceholder')}
                      className="w-full border rounded-md px-3 py-2 pr-10 text-sm transition-colors focus:outline-none focus:ring-1"
                      style={{
                        ...inputStyle,
                        '--tw-ring-color': 'var(--primary)'
                      } as React.CSSProperties}
                      required
                      disabled={isLoading}
                    />
                    <User
                      className="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4"
                      style={{ color: 'var(--text-secondary)' }}
                    />
                  </div>
                </div>

                {/* Password Input */}
                <div>
                  <div className="relative">
                    <input
                      type={showPassword ? 'text' : 'password'}
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      placeholder={t('login.passwordPlaceholder')}
                      className="w-full border rounded-md px-3 py-2 pr-10 text-sm transition-colors focus:outline-none focus:ring-1"
                      style={{
                        ...inputStyle,
                        '--tw-ring-color': 'var(--primary)'
                      } as React.CSSProperties}
                      required
                      disabled={isLoading}
                    />
                    <button
                      type="button"
                      onClick={() => setShowPassword(!showPassword)}
                      className="absolute right-3 top-1/2 -translate-y-1/2 transition-colors"
                      style={{ color: 'var(--text-secondary)' }}
                      disabled={isLoading}
                      aria-label={showPassword ? 'Parolni yashirish' : 'Parolni ko\'rsatish'}
                    >
                      {showPassword ? <EyeOff className="w-4 h-4" /> : <Eye className="w-4 h-4" />}
                    </button>
                  </div>
                </div>

                {/* Login Button */}
                <button
                  type="submit"
                  disabled={isLoading}
                  className="btn-primary w-full flex items-center justify-center gap-2"
                >
                  {isLoading ? (
                    <>
                      <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                      <span>{t('common.loading')}</span>
                    </>
                  ) : (
                    <>
                      <Lock className="w-4 h-4" />
                      <span>{t('auth.login_button')}</span>
                    </>
                  )}
                </button>
              </form>

              {/* Footer */}
              <div className="mt-6 text-center">
                <p className="text-xs text-caption">
                  © 2025 HEMIS. Barcha huquqlar himoyalangan.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}

export default LoginClean
